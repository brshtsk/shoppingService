## Описание проекта

Микросервисная система для создания счетов и оплаты заказов.

## Архитектура

### 1. Orders Service
- Создание заказов
- Просмотр списка заказов пользователя
- Проверка статуса заказа

### 2. Payments Service
- Создание счета пользователя
- Пополнение счета
- Проверка баланса
- Обработка платежей за заказы

### 3. RabbitMQ
Обеспечивает асинхронное взаимодействие между сервисами:
- Сообщения о создании заказа (OrderCreatedEvent)
- Сообщения о статусе платежа (PaymentCompletedEvent)

### 4. PostgreSQL
- OrdersDb и PaymentsDb

### 5. Api Gateway
- Обеспечивает единый вход для клиентов

## Паттерны и решения

### Transactional Outbox (Orders Service)
- При создании заказа данные о событии сохраняются в таблицу OutboxMessages в рамках той же транзакции

### Transactional Inbox и Outbox (Payments Service)
- **Inbox**: Гарантирует однократную обработку входящих сообщений, в том числе при повторной доставке
- **Outbox**: Обеспечивает сохранение сообщений о платежах в рамках транзакции

### Атомарные операции для баланса
При списании средств происходит блокировка, что предотвращает проблемы с конкурентным доступом к счету.
Также при возникновении ошибки при списании, транзакция возвращается в очередь, что реализует **Exactly Once** семантику.

## Запуск проекта

Для запуска используется `docker-compose`.

Работа с API возможна по адресу http://localhost:8000/swagger .

## API сервисов

### Payments Service API

#### Регистрация пользователя

```http
POST /api/Users/newUser
```
```json
{ "name": "string" }
```

#### Создание счета

```http
POST /api/Accounts/createAccount
```
```json
{ "userId": "GUID" }
```

#### Пополнение счета

```http
POST /api/Accounts/{userId}/topup
```

```json
{ "amount": 100.00 }
```

#### Проверка баланса

```http
GET /api/Accounts/{userId}/balance
```

### Orders Service API

#### Создание заказа

```http
POST /api/Orders/create
```
```json
{ "userId": "GUID", "amount": 100.00 }
```

#### Получение списка заказов пользователя

```http
GET /api/Orders/{userId}
```

#### Получение статуса заказа

```http
GET /api/Orders/{orderId}/status
```

## Тестирование

Проект содержит юнит-тесты для ключевых компонентов:
- Сервисы обработки заказов
- Сервисы обработки платежей
- Контракты сообщений